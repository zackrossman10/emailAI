<!DOCTYPE html>
<html lang="en">
<head>
  <script src="aws-sdk-2.302.0.min.js"></script>
  <script type="text/javascript">

  function hi(){
    // AWS.config.region = 'us-east-1'; // Region
    // AWS.config.accessKeyId =
    // AWS.config.secretAccessKey =
    //set up credenitals
    AWS.config.update({

      "region": "us-east-1"
    });

    //normalize and clean the input text
    var comprehend = new AWS.Comprehend();
    var originalText = document.getElementById("raw_text").value;
    //remove special chars before querying Comprehend API
    originalText = originalText.replace(new RegExp(/[,;.)(\"/\\]/, 'g'), "");
    var params = {
      LanguageCode: "en", /* required */
      Text: originalText /* required */
    };
    comprehend.detectEntities(params, function (err, data) {
      if (err) console.log(err, err.stack); // an error occurred
      else
        var awsNormalizedText = comprehendNormalize(originalText, data);
        var fullyNormalizedText = searchReplaceNormalization(awsNormalizedText);
        console.log("***********")
        console.log("***********")
        console.log(fullyNormalizedText);
        predict(fullyNormalizedText);
    });
  }

  function predict(fullyNormalizedText){
    var machinelearning = new AWS.MachineLearning();
    var containsDate = fullyNormalizedText.indexOf("[date]") > -1 ? '1' : '0';
    var containsQuestion = fullyNormalizedText.indexOf('?') > -1 ? '1' : '0';
    console.log(containsDate + ": "+containsQuestion);
    var params = {
      MLModelId: 'ml-mUXyHTyRl21', /* required */
      PredictEndpoint: 'https://realtime.machinelearning.us-east-1.amazonaws.com', /* required */
      Record: { /* required */
        'Var2': fullyNormalizedText,
        'Var3' : containsDate,
        'Var4' : containsQuestion
      }
    };
    machinelearning.predict(params, function(err, data) {
      if (err) console.log(err, err.stack); // an error occurred
      else
        var classifications = ["Descriptive content", "Action Items", "Other (salutation, non-work)", "Contact Info", "Event", "Inquiry/Question"];
        var classification = data["Prediction"]["predictedLabel"]
        var scores = data["Prediction"]["predictedScores"];
        console.log(data);
        classifications.forEach(function(classification){
          console.log(classification+": "+scores[classification]);
        });
        // console.log(classification);
        // console.log(score);
        document.getElementById("classification").innerHTML = "Classification: "+classification;
        document.getElementById("score").innerHTML = "Confidence: "+scores[classification];
    });
  }

  function comprehendNormalize(originalText, data){
    entityArr = data["Entities"];
    for(var i = 0; i<entityArr.length; i++){
      entity = entityArr[i]["Type"]
      if(entity == "PERSON"){
        text = entityArr[i]["Text"];
        originalText = originalText.replace(text, "[pronoun-subject]");
      }else if(entity == "DATE"){
        text = entityArr[i]["Text"];
        originalText = originalText.replace(text, "[date]");
      }
    }
    return originalText;
  }

  function searchReplaceNormalization(originalText){

    originalText = originalText.replace(new RegExp("'m", 'g'), " am");
    originalText = originalText.replace(new RegExp("'re", 'g'), " are");
    originalText = originalText.replace(new RegExp("'ll", 'g'), " will");
    originalText = originalText.replace(new RegExp("'ve", 'g'), " have");
    originalText = originalText.replace(new RegExp("won't", 'g'), " will not");
    originalText = originalText.replace(new RegExp("doesn't", 'g'), " does not");
    originalText = originalText.replace(new RegExp("'d", 'g'), " would");
    originalText = originalText.replace(new RegExp("what's", 'g'), "what is");
    originalText = originalText.replace(new RegExp(/[0-9]+/, 'g'), "[number]");
    originalText = originalText.replace(new RegExp(/(why |who |where |what |when )/, 'gi'), "[wwhh] ");
    originalText = originalText.replace(new RegExp(/(after|during|before)/, 'gi'), "[aaafter]");
    //careful not to overmatch, "*" is end-of=line character
    originalText = originalText.replace(new RegExp(/( we | you[ *]| he | she | they )/, 'gi'), " [pronoun] ");
    originalText = originalText.replace(new RegExp(/(I |We |You |He |She |They )/, 'g'), "[pronoun-subject] ");
    originalText = originalText.replace(new RegExp(/( me[ *]| us[ *]| them[ *])/, 'g'), " [pronoun-object] ");
    //delete EOL characters
    return originalText.replace(new RegExp(/[*]/, 'g'), "");;
  }
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <div>
    <textarea rows ="9" cols = "20" id="raw_text" placeholder= "Message" style = "font-size: 14px;"></textarea>
    <button type="submit" onclick="hi()">Submit</button>
  </div>
  <div>
    <p id = "classification"></p>
    <p id = "score"></p>
  </div>
</body>
</html>
